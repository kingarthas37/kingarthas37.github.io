var assert = require('assert');
var should = require('should');
var api = require('../api');
var config = require('./api.json');
var cacheConfig  = {host:'10.10.100.15',port:11311,prefix:'tejia'};

api.config(config,cacheConfig);


describe('CmsApi',function(){

    beforeEach(function(done){
        api = require('../api');
        done();
    });


    describe('#config()',function(){
        it('config is right',function(done){
            var config = api.getConfig();

            console.log(config);

            config.should.not.empty;

            config.should.have.ownProperty('bbs');

            config.should.have.propertyByPath('bbs','actions','forums');

            config.bbs.actions.should.containDeep({
                hotTags : "get_hot_tags",
                panels : "get_index_panels"
            });

            done();
        });
    });

    describe('#get()',function(){
        it('response with results of get method',function(done){
            var url = 'http://cms-api.b5m.com/bbs/index.php?a=get_banner_images&page_size=&page=&field=&sort=';

            api.get(url)(function(err,res){
                if(err) return done(err);
                res.should.not.be.empty;
                done();
            });
        });
    });

    describe('#get()',function(){
        it('get data from cache',function(done){
            var url = 'http://cms-api.b5m.com/bbs/index.php?a=get_banner_images&page_size=&page=&field=&sort=';
            var cache = {left:100};

            api.get(url,cache)(function(err,res){
                if(err) return done(err);
                res.should.not.be.empty;
                done();
            });
        });
    });


    describe('#post()',function(){
        it('response with results of post method',function(done){
            var url = 'http://cms-api.b5m.com/bbs/index.php?a=post_comment&forum_id=1';

            api.post(url,{topic_id:1,content:123,uid:'6fd0277d04754c4089c761605385fa91'})(function(err,res){
                if(err) return done(err);
                done();
            });
        });
    });

    describe('#parallel()',function(){
        it('response with results of parallel method',function(done){
            var params = {
                bbs : [
                    'forums',
                    {key : 'topicsOfForum' ,params:{forum_id : 1}}
                ]
            };

            api.parallel(params,function(err,res){
                if(err) return done(err);

                res.forums.should.not.empty;


                done();
            });
        });
    });


});
